version: '3.8'

networks:
  public_net:
    driver: overlay
  core_net: # Swarm内の全アプリが通信するための共通ネットワーク
    driver: overlay

volumes:
  minio_data:
    driver: local
    driver_opts: { type: none, o: bind, device: /mnt/glusterfs/swarm-vol/minio }
  nextcloud_config: # S3を使うため、ファイル本体は保存されず設定ファイルのみ
    driver: local
    driver_opts: { type: none, o: bind, device: /mnt/glusterfs/swarm-vol/nextcloud_config }
  nextcloud_db_data:
    driver: local
    driver_opts: { type: none, o: bind, device: /mnt/glusterfs/swarm-vol/nextcloud_db }
  immich_app_data:
    driver: local
    driver_opts: { type: none, o: bind, device: /mnt/glusterfs/swarm-vol/immich_app }
  immich_db_data:
    driver: local
    driver_opts: { type: none, o: bind, device: /mnt/glusterfs/swarm-vol/immich_db }

services:
  # ==========================================
  # 1. MinIO (データ母艦)
  # ==========================================
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_PASSWORD}
    volumes:
      - minio_data:/data
    networks:
      - public_net
      - core_net

  # MinIO起動直後にバケットを自動作成する便利コンテナ
  minio-setup:
    image: minio/mc
    depends_on:
      - minio
    networks:
      - core_net
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      mc alias set myminio http://minio:9000 ${MINIO_USER} ${MINIO_PASSWORD};
      mc mb myminio/nextcloud --ignore-existing;
      mc mb myminio/fax-backup --ignore-existing;
      exit 0;
      "

  # ==========================================
  # 2. Nextcloud + DB + Redis
  # ==========================================
  nextcloud-db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=${NC_DB_USER}
      - POSTGRES_PASSWORD=${NC_DB_PASSWORD}
    volumes:
      - nextcloud_db_data:/var/lib/postgresql/data
    networks:
      - core_net

  nextcloud-redis:
    image: redis:alpine
    networks:
      - core_net

  nextcloud:
    image: nextcloud:apache
    environment:
      - POSTGRES_HOST=nextcloud-db
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=${NC_DB_USER}
      - POSTGRES_PASSWORD=${NC_DB_PASSWORD}
      - REDIS_HOST=nextcloud-redis
      - NEXTCLOUD_ADMIN_USER=${NC_ADMIN_USER}
      - NEXTCLOUD_ADMIN_PASSWORD=${NC_ADMIN_PASSWORD}
      - NEXTCLOUD_TRUSTED_DOMAINS=${NC_DOMAIN}
    volumes:
      - nextcloud_config:/var/www/html # 実データはMinIOへ行くので容量は食わない
    networks:
      - public_net
      - core_net
    depends_on:
      - nextcloud-db
      - nextcloud-redis
      - minio-setup

  # ==========================================
  # 3. Asterisk (FAXサーバー)
  # ==========================================
  asterisk:
    image: andrius/asterisk:latest # ※お使いのAsteriskイメージに変更してください
    # ports:
    #   - "5060:5060/udp" # SIPポートなど外部公開が必要な場合
    networks:
      - core_net
    # volumes:
    #   - /path/to/asterisk/etc:/etc/asterisk

  # ※ImmichとCloudflaredの記述は長くなるため省略していますが、
  # 以前と同じように core_net に参加させる形で追加してください。