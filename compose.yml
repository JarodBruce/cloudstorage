version: '3.8'

networks:
  public_net: # Cloudflare Tunnel用
    driver: overlay
  core_net:   # 内部通信用
    driver: overlay

volumes:
  minio_data:
    driver: local
    driver_opts: { type: none, o: bind, device: /mnt/glusterfs/swarm-vol/minio }
  nextcloud_config:
    driver: local
    driver_opts: { type: none, o: bind, device: /mnt/glusterfs/swarm-vol/nextcloud_config }
  nextcloud_db_data:
    driver: local
    driver_opts: { type: none, o: bind, device: /mnt/glusterfs/swarm-vol/nextcloud_db }
  immich_app_data:
    driver: local
    driver_opts: { type: none, o: bind, device: /mnt/glusterfs/swarm-vol/immich_app }
  immich_db_data:
    driver: local
    driver_opts: { type: none, o: bind, device: /mnt/glusterfs/swarm-vol/immich_db }

services:
  # ==========================================
  # 1. Cloudflare Tunnels
  # ==========================================
  cloudflared:
    image: cloudflare/cloudflared:latest
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - public_net
    deploy:
      replicas: 2

  # ==========================================
  # 2. MinIO (データ母艦) + 自動バケット作成
  # ==========================================
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_PASSWORD}
    volumes:
      - minio_data:/data
    networks:
      - public_net
      - core_net

  minio-setup:
    image: minio/mc
    depends_on:
      - minio
    networks:
      - core_net
    entrypoint: >
      /bin/sh -c "
      sleep 10;
      mc alias set myminio http://minio:9000 ${MINIO_USER} ${MINIO_PASSWORD};
      mc mb myminio/nextcloud --ignore-existing;
      mc mb myminio/immich --ignore-existing;
      exit 0;
      "
    deploy:
      restart_policy:
        condition: on-failure

  # ==========================================
  # 3. Nextcloud + DB + Redis
  # ==========================================
  nextcloud-db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=${NC_DB_USER}
      - POSTGRES_PASSWORD=${NC_DB_PASSWORD}
    volumes:
      - nextcloud_db_data:/var/lib/postgresql/data
    networks:
      - core_net

  nextcloud-redis:
    image: redis:alpine
    networks:
      - core_net

  nextcloud:
    image: nextcloud:apache
    environment:
      - POSTGRES_HOST=nextcloud-db
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=${NC_DB_USER}
      - POSTGRES_PASSWORD=${NC_DB_PASSWORD}
      - REDIS_HOST=nextcloud-redis
      - NEXTCLOUD_ADMIN_USER=${NC_ADMIN_USER}
      - NEXTCLOUD_ADMIN_PASSWORD=${NC_ADMIN_PASSWORD}
      - NEXTCLOUD_TRUSTED_DOMAINS=${NC_DOMAIN}
      # --- MinIO(S3)をプライマリストレージにする自動設定 ---
      - OBJECTSTORE_S3_BUCKET=nextcloud
      - OBJECTSTORE_S3_KEY=${MINIO_USER}
      - OBJECTSTORE_S3_SECRET=${MINIO_PASSWORD}
      - OBJECTSTORE_S3_HOST=minio
      - OBJECTSTORE_S3_PORT=9000
      - OBJECTSTORE_S3_SSL=false
      - OBJECTSTORE_S3_REGION=us-east-1
      - OBJECTSTORE_S3_USEPATH_STYLE=true
      - OBJECTSTORE_S3_AUTOCREATE=true
    volumes:
      - nextcloud_config:/var/www/html
    networks:
      - public_net
      - core_net
    depends_on:
      - nextcloud-db
      - nextcloud-redis
      - minio-setup

  # ==========================================
  # 4. Collabora + Nextcloud Office 自動セットアップ
  # ==========================================
  collabora:
    image: collabora/code:latest
    environment:
      - domain=${NC_DOMAIN_ESCAPED} # 例: nextcloud\\.yourdomain\\.com
      - dictionaries=en_US,ja_JP
      - extra_params=--o:ssl.enable=false --o:ssl.termination=true
    networks:
      - public_net
      - core_net

  nextcloud-setup:
    image: nextcloud:apache
    volumes:
      - nextcloud_config:/var/www/html
    networks:
      - core_net
    depends_on:
      - nextcloud
      - collabora
    entrypoint: /bin/bash
    # Nextcloudが初期化されるのを待ってからCollaboraの設定を注入するスクリプト
    command: >
      -c "
      echo 'Waiting for Nextcloud to finish installation...';
      while ! su -s /bin/bash www-data -c 'php occ status' | grep -q 'installed: true'; do
        sleep 10;
      done;
      echo 'Nextcloud is ready! Configuring Collabora Office...';
      su -s /bin/bash www-data -c 'php occ app:install richdocuments';
      su -s /bin/bash www-data -c 'php occ config:app:set richdocuments wopi_url --value=\"https://collabora.${NC_DOMAIN_BARE}\"';
      echo 'Setup finished!';
      "
    deploy:
      restart_policy:
        condition: on-failure

  # ==========================================
  # 5. Immich (以前のまま)
  # ==========================================
  immich-db:
    image: tensorchord/pgvecto-rs:pg14-v0.2.0@sha256:90724186f0a3517cf6914295b5ab410db9ce23190a2d9d0b9dd6463e3fa298f0
    environment:
      POSTGRES_PASSWORD: ${IMMICH_DB_PASSWORD}
      POSTGRES_USER: ${IMMICH_DB_USER}
      POSTGRES_DB: immich
    volumes:
      - immich_db_data:/var/lib/postgresql/data
    networks:
      - core_net

  immich-redis:
    image: redis:6.2-alpine@sha256:e3b17ba9479deec4b7d1eeec1548a253acc5374d68d3b27937fcfe4df8d18c7e
    networks:
      - core_net

  immich-server:
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    command: [ "start.sh", "immich" ]
    volumes:
      - immich_app_data:/usr/src/app/upload
    environment:
      - DB_HOSTNAME=immich-db
      - DB_USERNAME=${IMMICH_DB_USER}
      - DB_PASSWORD=${IMMICH_DB_PASSWORD}
      - DB_DATABASE_NAME=immich
      - REDIS_HOSTNAME=immich-redis
    networks:
      - public_net
      - core_net
    depends_on:
      - immich-db
      - immich-redis

  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION:-release}
    volumes:
      - immich_app_data:/usr/src/app/upload
    networks:
      - core_net