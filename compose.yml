version: '3.8'

networks:
  public_net: # Cloudflare Tunnelからのアクセス用
    driver: overlay
  nextcloud_net:
    driver: overlay
  immich_net:
    driver: overlay

volumes:
  minio_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/glusterfs/swarm-vol/minio
  nextcloud_app_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/glusterfs/swarm-vol/nextcloud_app
  nextcloud_db_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/glusterfs/swarm-vol/nextcloud_db
  immich_app_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/glusterfs/swarm-vol/immich_app
  immich_db_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/glusterfs/swarm-vol/immich_db

services:
  # ==========================================
  # 1. Cloudflare Tunnels (外部公開・リバースプロキシ役)
  # ==========================================
  cloudflared:
    image: cloudflare/cloudflared:latest
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - public_net
    deploy:
      replicas: 2 # トンネルは複数稼働で冗長化可能

  # ==========================================
  # 2. MinIO (オブジェクトストレージ)
  # ==========================================
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_PASSWORD}
    volumes:
      - minio_data:/data
    networks:
      - public_net

  # ==========================================
  # 3. Nextcloud + Collabora + DB + Redis
  # ==========================================
  nextcloud-db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=${NC_DB_USER}
      - POSTGRES_PASSWORD=${NC_DB_PASSWORD}
    volumes:
      - nextcloud_db_data:/var/lib/postgresql/data
    networks:
      - nextcloud_net

  nextcloud-redis:
    image: redis:alpine
    networks:
      - nextcloud_net

  nextcloud:
    image: nextcloud:apache
    environment:
      - POSTGRES_HOST=nextcloud-db
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=${NC_DB_USER}
      - POSTGRES_PASSWORD=${NC_DB_PASSWORD}
      - REDIS_HOST=nextcloud-redis
      - NEXTCLOUD_ADMIN_USER=${NC_ADMIN_USER}
      - NEXTCLOUD_ADMIN_PASSWORD=${NC_ADMIN_PASSWORD}
      - NEXTCLOUD_TRUSTED_DOMAINS=${NC_DOMAIN}
    volumes:
      - nextcloud_app_data:/var/www/html
    networks:
      - public_net
      - nextcloud_net
    depends_on:
      - nextcloud-db
      - nextcloud-redis
    deploy:
      placement:
        constraints: [node.labels.storage == true]

  collabora:
    image: collabora/code:latest
    environment:
      - domain=${NC_DOMAIN_ESCAPED} # 例: nextcloud\\.example\\.com
      - dictionaries=en_US,ja_JP
      - extra_params=--o:ssl.enable=false --o:ssl.termination=true
    networks:
      - public_net
      - nextcloud_net

  # ==========================================
  # 4. Immich (写真バックアップ)
  # ==========================================
  immich-db:
    image: tensorchord/pgvecto-rs:pg14-v0.2.0@sha256:90724186f0a3517cf6914295b5ab410db9ce23190a2d9d0b9dd6463e3fa298f0
    environment:
      POSTGRES_PASSWORD: ${IMMICH_DB_PASSWORD}
      POSTGRES_USER: ${IMMICH_DB_USER}
      POSTGRES_DB: immich
    volumes:
      - immich_db_data:/var/lib/postgresql/data
    networks:
      - immich_net

  immich-redis:
    image: redis:6.2-alpine@sha256:e3b17ba9479deec4b7d1eeec1548a253acc5374d68d3b27937fcfe4df8d18c7e
    networks:
      - immich_net

  immich-server:
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    command: [ "start.sh", "immich" ]
    volumes:
      - immich_app_data:/usr/src/app/upload
    environment:
      - DB_HOSTNAME=immich-db
      - DB_USERNAME=${IMMICH_DB_USER}
      - DB_PASSWORD=${IMMICH_DB_PASSWORD}
      - DB_DATABASE_NAME=immich
      - REDIS_HOSTNAME=immich-redis
    networks:
      - public_net
      - immich_net
    depends_on:
      - immich-db
      - immich-redis

  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION:-release}
    volumes:
      - immich_app_data:/usr/src/app/upload
    networks:
      - immich_net
